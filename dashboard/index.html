<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Usage & Cost Tracker - San Diego</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .period-selector {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .period-btn {
            background: #1e293b;
            color: #e2e8f0;
            border: 2px solid #334155;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .period-btn:hover {
            background: #334155;
        }

        .period-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #334155;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stat-label {
            font-size: 0.85rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #e2e8f0;
        }

        .stat-unit {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-left: 5px;
        }

        .chart-container {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #334155;
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #e2e8f0;
        }

        .logs-section {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .logs-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
        }

        .logs-table th {
            background: #0f172a;
            padding: 12px;
            text-align: left;
            font-size: 0.85rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #334155;
        }

        .logs-table td {
            padding: 12px;
            border-bottom: 1px solid #334155;
            font-size: 0.9rem;
        }

        .logs-table tr:hover {
            background: #0f172a;
        }

        .truncate {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cost-positive {
            color: #34d399;
        }

        .cost-high {
            color: #fbbf24;
        }

        .error {
            color: #f87171;
        }

        .status-success {
            color: #34d399;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.5rem;
            }

            .logs-table {
                font-size: 0.8rem;
            }

            .truncate {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“Š Ollama Usage & Cost Tracker</h1>
            <p class="subtitle">San Diego SDG&E Â· M4 Max Â· Real-time monitoring</p>
        </header>

        <div class="period-selector">
            <button class="period-btn active" onclick="changePeriod('today')">Today</button>
            <button class="period-btn" onclick="changePeriod('week')">Week</button>
            <button class="period-btn" onclick="changePeriod('month')">Month</button>
            <button class="period-btn" onclick="changePeriod('year')">Year</button>
            <button class="period-btn" onclick="changePeriod('all')">All Time</button>
            <button class="refresh-btn" onclick="refreshData()">ðŸ”„ Refresh</button>
        </div>

        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Requests</div>
                <div class="stat-value" id="total-requests">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Tokens</div>
                <div class="stat-value" id="total-tokens">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Power Consumed</div>
                <div class="stat-value" id="total-power">-</div>
                <span class="stat-unit">Wh</span>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Cost</div>
                <div class="stat-value cost-positive" id="total-cost">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Duration</div>
                <div class="stat-value" id="avg-duration">-</div>
                <span class="stat-unit">sec</span>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Cost/Request</div>
                <div class="stat-value" id="avg-cost">-</div>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Hourly Usage (Last 24 Hours)</h2>
            <canvas id="hourlyChart"></canvas>
        </div>

        <div class="logs-section">
            <h2 class="chart-title">Recent Requests</h2>
            <input type="text" class="search-box" id="search-box" placeholder="Search prompts and responses..." onkeyup="searchLogs()">
            <div style="overflow-x: auto;">
                <table class="logs-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Model</th>
                            <th>Prompt</th>
                            <th>Response</th>
                            <th>Tokens</th>
                            <th>Duration</th>
                            <th>Cost</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="logs-tbody">
                        <tr><td colspan="8" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentPeriod = 'today';
        let hourlyChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadHourlyChart();
            loadRecentLogs();

            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadStats();
                loadHourlyChart();
                loadRecentLogs();
            }, 30000);
        });

        function changePeriod(period) {
            currentPeriod = period;

            // Update button states
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            loadStats();
        }

        function refreshData() {
            loadStats();
            loadHourlyChart();
            loadRecentLogs();
        }

        async function loadStats() {
            try {
                const response = await fetch(`/api/stats/overview?period=${currentPeriod}`);
                const data = await response.json();

                document.getElementById('total-requests').textContent = data.total_requests.toLocaleString();
                document.getElementById('total-tokens').textContent = data.total_tokens.toLocaleString();
                document.getElementById('total-power').textContent = data.total_power_wh.toFixed(2);
                document.getElementById('total-cost').textContent = '$' + data.total_cost_dollars.toFixed(4);
                document.getElementById('avg-duration').textContent = data.avg_duration_seconds.toFixed(2);
                document.getElementById('avg-cost').textContent = '$' + data.avg_cost_dollars.toFixed(6);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadHourlyChart() {
            try {
                const response = await fetch('/api/stats/hourly?hours=24');
                const data = await response.json();

                const labels = data.hours.map(h => new Date(h.hour).toLocaleTimeString('en-US', { hour: 'numeric', hour12: true }));
                const requests = data.hours.map(h => h.requests);
                const costs = data.hours.map(h => h.cost_dollars);

                const ctx = document.getElementById('hourlyChart').getContext('2d');

                if (hourlyChart) {
                    hourlyChart.destroy();
                }

                hourlyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Requests',
                                data: requests,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                yAxisID: 'y',
                                tension: 0.3
                            },
                            {
                                label: 'Cost ($)',
                                data: costs,
                                borderColor: '#34d399',
                                backgroundColor: 'rgba(52, 211, 153, 0.1)',
                                yAxisID: 'y1',
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                ticks: { color: '#94a3b8' },
                                grid: { drawOnChartArea: false },
                            },
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#e2e8f0' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading hourly chart:', error);
            }
        }

        async function loadRecentLogs() {
            try {
                const response = await fetch('/api/logs/recent?limit=50');
                const data = await response.json();

                const tbody = document.getElementById('logs-tbody');
                tbody.innerHTML = '';

                if (data.logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="loading">No logs yet</td></tr>';
                    return;
                }

                data.logs.forEach(log => {
                    const tr = document.createElement('tr');
                    const time = new Date(log.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    const statusClass = log.http_status === 200 ? 'status-success' : 'error';
                    const costClass = log.cost_dollars > 0.001 ? 'cost-high' : 'cost-positive';

                    tr.innerHTML = `
                        <td>${time}</td>
                        <td>${log.model || 'N/A'}</td>
                        <td class="truncate" title="${log.prompt_preview}">${log.prompt_preview || 'N/A'}</td>
                        <td class="truncate" title="${log.response_preview}">${log.response_preview || 'N/A'}</td>
                        <td>${log.total_tokens}</td>
                        <td>${log.duration_seconds}s</td>
                        <td class="${costClass}">$${log.cost_dollars.toFixed(6)}</td>
                        <td class="${statusClass}">${log.http_status}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading recent logs:', error);
            }
        }

        async function searchLogs() {
            const query = document.getElementById('search-box').value;

            if (query.length < 2) {
                loadRecentLogs();
                return;
            }

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=50`);
                const data = await response.json();

                const tbody = document.getElementById('logs-tbody');
                tbody.innerHTML = '';

                if (data.results.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="loading">No results found</td></tr>';
                    return;
                }

                data.results.forEach(log => {
                    const tr = document.createElement('tr');
                    const time = new Date(log.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

                    tr.innerHTML = `
                        <td>${time}</td>
                        <td>${log.model || 'N/A'}</td>
                        <td class="truncate" title="${log.prompt_preview}">${log.prompt_preview || 'N/A'}</td>
                        <td class="truncate" title="${log.response_preview}">${log.response_preview || 'N/A'}</td>
                        <td>${log.total_tokens}</td>
                        <td>-</td>
                        <td class="cost-positive">$${log.cost_dollars.toFixed(6)}</td>
                        <td>-</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error searching logs:', error);
            }
        }
    </script>
</body>
</html>
